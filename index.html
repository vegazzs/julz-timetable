<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ICAN Professional Timetable Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.15.0/ethers.umd.min.js"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Roboto:wght@300,400,500,700&display=swap");

      :root {
        --primary-blue: #0a3a8e; /* Navy Blue */
        --secondary-gray: #f4f6f9;
        --text-dark: #333;
        --text-light: #fff;
        --success-green: #10b981;
        --warning-orange: #f59e0b;
        --error-red: #ef4444;
        --submit-red: #cc0000;
        --close-red: #d90000;
        /* Professional Colors for Grade Display */
        --result-border: #f5b041; /* Gold/Amber */
        --grade-box-bg: #0d47a1; /* Darker, Formal Blue */
      }

      body {
        font-family: "Roboto", sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--secondary-gray);
        color: var(--text-dark);
        font-size: 16px; /* Base font size for desktop */
      }

      .header {
        background-color: var(--primary-blue);
        color: var(--text-light);
        padding: 15px 40px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
      }

      .header h1 {
        margin: 0 0 5px 0;
        font-size: 1.8em;
        font-weight: 500;
      }

      #name-output {
        font-size: 1.1em;
        font-weight: 300;
        margin: 0;
      }

      .container {
        max-width: 900px;
        margin: 40px auto;
        padding: 30px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
      }

      .controls {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        align-items: flex-end;
        flex-wrap: wrap;
      }

      .control-group {
        flex: 1;
        min-width: 150px; /* Ensure controls stack better on small screens */
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #555;
        font-size: 0.9em;
      }

      select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
        font-size: 1em;
        background-color: white;
        height: 42px;
      }

      .controls button {
        flex: 0 0 200px;
        padding: 12px;
        color: var(--text-light);
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1em;
        font-weight: 500;
        transition: background-color 0.2s, box-shadow 0.3s, transform 0.08s;
        height: 42px;
      }

      .controls button:hover {
        transform: translateY(-1px);
      }

      /* VIEW SCHEDULE (Blue) */
      #fetchButton {
        background-color: var(--primary-blue);
      }

      #fetchButton:hover {
        background-color: #082d6b;
      }

      /* GET PROGRESS (Green) */
      #progressButton {
        background-color: var(--success-green);
      }

      #progressButton:hover {
        background-color: #0e9a6c;
      }

      /* Pulse animation for progress button */
      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.6);
        }

        70% {
          box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
        }

        100% {
          box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
        }
      }

      #progressButton.pulsing {
        animation: pulse 1.5s ease-out;
      }

      /* Progress bar glow animation */
      @keyframes progressGlow {
        0% {
          background-position: 0 0;
        }

        100% {
          background-position: 40px 0;
        }
      }

      #progressBar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #10b981, #34d399, #10b981);
        background-size: 40px 40px;
        animation: progressGlow 2s linear infinite;
        transition: width 0.6s ease;
        border-radius: 6px;
      }

      .result-card {
        margin-top: 25px;
        padding: 25px;
        border-radius: 6px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border-top: 5px solid var(--primary-blue);
      }

      .result-card h3 {
        margin-top: 0;
        font-weight: 700;
        font-size: 1.4em;
        color: var(--primary-blue);
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 15px;
      }

      .result-detail {
        margin-bottom: 8px;
        font-size: 0.95em;
        line-height: 1.4;
      }

      .result-detail strong {
        display: inline-block;
        width: 100px;
        color: #555;
        font-weight: 500;
      }

      .question-list {
        list-style: decimal;
        padding-left: 20px;
        margin-top: 10px;
      }

      .question-list li {
        margin-bottom: 5px;
        font-weight: 400;
      }

      #loading {
        text-align: center;
        margin-top: 15px;
        color: var(--primary-blue);
        font-weight: 500;
        display: none;
      }

      .error {
        color: var(--error-red);
        font-weight: 500;
        padding: 10px;
        background-color: #fee2e2;
        border-radius: 4px;
      }

      .card-read-complete {
        border-top: 5px solid var(--success-green);
        background-color: #f0fff4;
      }

      .card-read-complete h3 {
        color: var(--success-green);
      }

      .card-read-complete .completion-check {
        font-size: 1.5em;
        color: var(--success-green);
        margin-top: 15px;
        font-weight: 700;
      }

      /* UPDATED STYLES FOR PROFESSIONAL GRADE PAGE */
      .card-exam-complete {
        border-top: 5px solid var(--result-border); /* Gold/Amber Border */
        background-color: #fffaf0; /* Very light yellow/cream background */
        text-align: center;
      }

      .card-exam-complete h3 {
        color: var(--primary-blue); /* Navy Blue Header */
      }

      .card-exam-complete .grade-display {
        font-size: 3em; /* Larger size */
        font-weight: 700;
        color: var(--text-light); /* White text */
        background-color: var(--grade-box-bg); /* Dark Formal Blue background */
        padding: 20px 40px;
        border: 2px solid var(--result-border); /* Gold Border */
        display: inline-block;
        margin-top: 10px;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); /* Subtle shadow */
        letter-spacing: 2px;
      }

      .card-exam-complete p {
        color: #555;
        font-style: italic;
      }
      /* END UPDATED STYLES */

      .card-exam-active {
        border-top: 5px solid var(--error-red);
        background-color: #fef2f2;
      }

      .card-exam-active h3 {
        color: var(--error-red);
      }

      .card-exam-active .countdown-timer {
        font-size: 1.5em;
        font-weight: 700;
        color: var(--error-red);
        margin: 10px 0;
        padding: 8px;
        background-color: #fff;
        border-radius: 4px;
        border: 1px dashed var(--error-red);
      }

      /* FANCY RED CLOSE BUTTON STYLES */
      .card-exam-active .close-button {
        /* General Styling */
        color: white;
        padding: 15px 30px;
        font-size: 1.2em;
        border: 1px solid #900000;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 25px;
        font-weight: 700;
        display: block;
        width: 100%;
        text-shadow: 0 1px 1px rgba(0, 0, 0, 0.3);

        /* Red Gradient */
        background-color: var(--close-red);
        background-image: linear-gradient(to bottom, #ff3333, var(--close-red));

        /* 3D-ish Shadow */
        box-shadow: 0 5px 0 #900000;

        /* Transition for smooth hover effect */
        transition: all 0.15s ease-out;

        height: auto;
      }

      .card-exam-active .close-button:hover {
        background-image: linear-gradient(to bottom, #ff4444, #e60000);
        box-shadow: 0 5px 0 #800000;
      }

      .card-exam-active .close-button:active {
        /* Make it look "pressed" */
        box-shadow: 0 2px 0 #800000;
        transform: translateY(3px);
      }

      .card-exam-start-pending button {
        background-color: var(--success-green) !important;
        color: white;
        padding: 15px 30px;
        font-size: 1.2em;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 25px;
        transition: background-color 0.2s;
        font-weight: 700;
        display: block;
        width: 100%;
      }
      .card-exam-start-pending button:hover {
        background-color: #0e9a6c !important;
      }

      /* Style for the pre-formatted question text */
      .question-content {
        white-space: pre-wrap;
        text-align: left;
        background-color: #f9f9f9;
        padding: 15px;
        border-radius: 4px;
        border: 1px dashed #ccc;
        margin-top: 15px;
        font-family: monospace, sans-serif;
        font-size: 0.9em;
      }
      .card-exam-active .question-content {
        background-color: #fff;
        border: 1px solid var(--error-red);
      }

      /* ======================================= */
      /* 💡 MOBILE STYLES (Screen size up to 600px) */
      /* ======================================= */
      @media (max-width: 600px) {
        body {
          padding: 5px; /* Minimal padding */
          font-size: 16px; /* Standard font size */
        }

        .header {
          padding: 10px 15px; /* Reduced header padding */
        }

        .header h1 {
          font-size: 1.5em; /* Smaller header */
        }

        .container {
          margin: 10px auto; /* Reduced margin */
          padding: 15px;
        }

        /* Layout: Force controls to stack the two selects, and then stack the two buttons below them */
        .controls {
          flex-direction: column;
          gap: 10px; /* Reduced gap */
        }

        .control-group {
          min-width: 100%;
        }

        /* New container for buttons only */
        .button-group-mobile {
          display: flex;
          width: 100%;
          gap: 10px;
          /* Added to ensure buttons wrap nicely below selects */
          flex-wrap: wrap;
        }

        .controls button {
          /* NEW: Set button width to 50% minus half the gap, allowing them to sit side-by-side */
          flex: 1 1 calc(50% - 5px);
          padding: 8px; /* Further reduced padding */
          height: 38px; /* Smaller height */
          font-size: 0.9em; /* Slightly smaller font */
          margin-top: 0; /* Remove top margin if it existed */
          /* Ensure buttons don't grow too wide if only one is present */
          max-width: 100%;
        }

        /* Adjust font sizes to be less "bold" */
        .result-card h3 {
          font-size: 1.3em;
        }

        /* Adjust width of labels to give more space to the value */
        .result-detail strong {
          width: 80px;
        }

        .card-exam-complete .grade-display {
          font-size: 2.5em; /* Smaller final grade */
          padding: 15px 30px;
        }

        .card-exam-active .countdown-timer {
          font-size: 1.4em; /* Smaller timer text */
        }

        .card-exam-active .close-button,
        .card-exam-start-pending button {
          padding: 12px 20px; /* Smaller padding */
          font-size: 1em; /* Smaller font */
        }
      }
    </style>
  </head>

  <body>
    <div class="header">
      <h1>ICAN STUDYING TIMETABLE & MOCK EXAM</h1>
      <p id="name-output">Candidate: Loading...</p>
    </div>

    <div class="container">
      <h2>Schedule Lookup</h2>
      <div class="controls">
        <div class="control-group">
          <label for="weekNumber">Select Week (1-6):</label>
          <select id="weekNumber"></select>
        </div>
        <div class="control-group">
          <label for="dayNumber">Select Day (1-7):</label>
          <select id="dayNumber"></select>
        </div>
        <div class="button-group-mobile">
          <button id="fetchButton" onclick="fetchTimetable()">
            VIEW SCHEDULE
          </button>
          <button id="progressButton" onclick="fetchProgress()">
            GET PROGRESS
          </button>
        </div>
      </div>

      <div id="progressContainer" style="display: none; margin-top: 20px">
        <h3 style="color: var(--primary-blue)">Overall Progress</h3>
        <div id="progressText" style="margin-bottom: 8px; font-weight: 500">
          Loading...
        </div>
        <div
          style="
            background: #eee;
            border-radius: 6px;
            height: 20px;
            overflow: hidden;
          "
        >
          <div id="progressBar"></div>
        </div>
      </div>

      <p id="loading">Requesting data from the blockchain node... ⏱️</p>

      <div id="output">
        <div class="result-card">
          <h3>Welcome Onyinye!</h3>
          <p>
            Use the dropdowns and click 'View Schedule' to see the day's plan.
          </p>
        </div>
      </div>
    </div>

    <script>
      // --- CONFIG: set your RPC URL here ---
      const RPC_URL =
        "https://sepolia.infura.io/v3/42b75fb9db97417ca4914eaa577d8252";
      const CONTRACT_ADDRESS = "0x27179B1dbf104AcC7837298c75a89f2F35C92B8a";

      // ABI definitions
      const ABI = [
        {
          inputs: [],
          name: "candidateName",
          outputs: [{ internalType: "string", name: "", type: "string" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "getCompletionStats",
          outputs: [
            { internalType: "uint8", name: "completedDays", type: "uint8" },
            { internalType: "uint8", name: "totalDays", type: "uint8" },
            { internalType: "uint256", name: "percentage", type: "uint256" },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [
            { internalType: "uint8", name: "weekNumber", type: "uint8" },
            { internalType: "uint8", name: "dayNumber", type: "uint8" },
          ],
          name: "getToday",
          outputs: [
            { internalType: "uint8", name: "dayType", type: "uint8" },
            { internalType: "string", name: "subject", type: "string" },
            { internalType: "string", name: "title", type: "string" },
            { internalType: "string[]", name: "topics", type: "string[]" },
            { internalType: "string[]", name: "questions", type: "string[]" },
            { internalType: "string", name: "grade", type: "string" },
            { internalType: "string", name: "time", type: "string" },
            { internalType: "uint256", name: "startTime", type: "uint256" },
            { internalType: "uint256", name: "duration", type: "uint256" },
            { internalType: "bool", name: "isCompleted", type: "bool" },
            { internalType: "string", name: "ipfsLink", type: "string" },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [
            { internalType: "uint8", name: "weekNumber", type: "uint8" },
            { internalType: "uint8", name: "dayNumber", type: "uint8" },
          ],
          name: "startExamDay",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [
            { internalType: "uint8", name: "weekNumber", type: "uint8" },
            { internalType: "uint8", name: "dayNumber", type: "uint8" },
          ],
          name: "completeExamDay",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
      ];

      const DAY_TYPES = ["Not Set", "Reading Day", "Exam Day"];
      const DAYS_OF_WEEK = {
        1: "Day 1 (Mon)",
        2: "Day 2 (Tue)",
        3: "Day 3 (Wed)",
        4: "Day 4 (Thu)",
        5: "Day 5 (Fri)",
        6: "Day 6 (Sat)",
        7: "Day 7 (Sun)",
      };

      let provider = null;
      let contract = null;
      let countdownInterval;

      function initProviderContract() {
        try {
          if (
            RPC_URL &&
            !RPC_URL.includes("YOUR_RPC_URL") &&
            CONTRACT_ADDRESS &&
            !CONTRACT_ADDRESS.includes("YOUR_CONTRACT_ADDRESS")
          ) {
            provider = new ethers.JsonRpcProvider(RPC_URL);
            contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);
          } else {
            provider = null;
            contract = null;
            console.warn(
              "RPC_URL or CONTRACT_ADDRESS not configured — running in offline mode."
            );
          }
        } catch (err) {
          console.error("init error", err);
          provider = null;
          contract = null;
        }
      }

      function populateDropdowns() {
        const weekSelect = document.getElementById("weekNumber");
        const daySelect = document.getElementById("dayNumber");
        weekSelect.innerHTML = "";
        daySelect.innerHTML = "";
        for (let i = 1; i <= 6; i++) {
          const opt = document.createElement("option");
          opt.value = i;
          opt.textContent = `Week ${i}`;
          weekSelect.appendChild(opt);
        }
        for (let i = 1; i <= 7; i++) {
          const opt = document.createElement("option");
          opt.value = i;
          opt.textContent = DAYS_OF_WEEK[i];
          daySelect.appendChild(opt);
        }
      }

      function stopCountdown() {
        if (countdownInterval) {
          clearInterval(countdownInterval);
          countdownInterval = null;
        }
      }

      /**
       * Starts the countdown timer.
       * @param {bigint} startTime - Unix timestamp in seconds (from contract).
       * @param {bigint} duration - Duration in minutes (from contract, e.g., 180n).
       */
      function startCountdown(startTime, duration) {
        const timerElement = document.getElementById("countdownTimer");
        if (!timerElement) return;

        stopCountdown();

        const durationMs = duration * 60n * 1000n;
        const startTimestampMs = startTime * 1000n;
        const endTimeMs = startTimestampMs + durationMs;

        const updateTimer = () => {
          const nowMs = BigInt(Date.now());
          let remainingMs = endTimeMs - nowMs;

          if (remainingMs <= 0n) {
            clearInterval(countdownInterval);
            timerElement.textContent =
              "TIME EXPIRED! Please submit your exam now.";
            timerElement.style.color = "var(--primary-blue)";
            return;
          }

          timerElement.textContent = `Time Remaining: ${formatDuration(
            remainingMs
          )}`;
        };

        updateTimer();
        countdownInterval = setInterval(updateTimer, 1000);
      }

      const formatTimestamp = (t) =>
        !t || Number(t) === 0
          ? "N/A"
          : new Date(Number(t) * 1000).toLocaleString();

      /**
       * Formats a duration from milliseconds to HH:MM:SS.
       * @param {bigint} durationInMilliseconds - Duration in milliseconds (BigInt).
       * @returns {string} - Formatted duration string.
       */
      function formatDuration(durationInMilliseconds) {
        const totalSecondsBigInt = durationInMilliseconds / 1000n;

        const totalHoursBigInt = totalSecondsBigInt / 3600n;
        const remainingSecondsAfterHours = totalSecondsBigInt % 3600n;

        const minutesBigInt = remainingSecondsAfterHours / 60n;
        const secondsBigInt = remainingSecondsAfterHours % 60n;

        const hours = Number(totalHoursBigInt);
        const minutes = Number(minutesBigInt);
        const seconds = Number(secondsBigInt);

        const pad = (num) => num.toString().padStart(2, "0");

        return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
      }

      async function fetchCandidateName() {
        try {
          if (!contract || typeof contract.candidateName !== "function") {
            document.getElementById("name-output").textContent =
              "Candidate: (Offline Mode)";
            return;
          }
          const name = await contract.candidateName();
          document.getElementById(
            "name-output"
          ).textContent = `Candidate: ${String(name).toUpperCase()}`;
        } catch (err) {
          console.error("candidateName error", err);
          document.getElementById("name-output").textContent =
            "Candidate: (Data Unavailable)";
        }
      }

      async function fetchProgress() {
        const container = document.getElementById("progressContainer");
        const text = document.getElementById("progressText");
        const bar = document.getElementById("progressBar");
        container.style.display = "block";

        if (!contract || typeof contract.getCompletionStats !== "function") {
          text.textContent = "Progress unavailable (contract not connected)";
          bar.style.width = "0%";
          return;
        }

        try {
          const [completed, total, percent] =
            await contract.getCompletionStats();

          const p = Number(percent) / 10000;
          const displayPercent = (p * 100).toFixed(1);

          text.textContent = `You’ve completed ${completed} out of ${total} days (${displayPercent}%)`;

          bar.style.width = `${displayPercent}%`;

          const btn = document.getElementById("progressButton");
          btn.classList.remove("pulsing");
          void btn.offsetWidth;
          btn.classList.add("pulsing");
        } catch (err) {
          console.error("getCompletionStats error", err);
          text.textContent = "Error retrieving progress.";
          bar.style.width = "0%";
        }
      }

      async function triggerExamStart(weekNum, dayNum) {
        const outputDiv = document.getElementById("output");
        outputDiv.innerHTML =
          '<div class="result-card"><span style="color:var(--warning-orange); font-weight:700;">REQUESTING START TIME TRANSACTION... PLEASE CONFIRM IN WALLET.</span></div>';

        try {
          if (!window.ethereum) {
            alert(
              "MetaMask or a similar wallet is required to start the exam."
            );
            await fetchTimetable();
            return;
          }

          const provider = new ethers.BrowserProvider(window.ethereum);
          const signer = await provider.getSigner();
          const writableContract = new ethers.Contract(
            CONTRACT_ADDRESS,
            ABI,
            signer
          );

          const tx = await writableContract.startExamDay(weekNum, dayNum);

          outputDiv.innerHTML =
            '<div class="result-card"><span style="color:var(--success-green); font-weight:700;">TRANSACTION SENT. WAITING FOR CONFIRMATION...</span></div>';

          await tx.wait();

          await fetchTimetable();
        } catch (err) {
          console.error("Exam Start Transaction Failed:", err);
          if (err.code === 4001) {
            outputDiv.innerHTML = `<div class="result-card"><span class="error">Start rejected. Please click the button again when ready.</span></div>`;
          } else {
            outputDiv.innerHTML = `<div class="result-card"><span class="error">Start failed. Error: ${
              err.message || "Check console."
            }</span></div>`;
          }
        }
      }

      /**
       * Locally clears the exam output display and stops the countdown.
       */
      function closeQuestionPage() {
        stopCountdown();
        const outputDiv = document.getElementById("output");
        outputDiv.innerHTML = `
              <div class="result-card">
                  <h3>Exam Window Closed</h3>
                  <p>The active exam view has been closed. Now submit a clear picture of your ANSWER SHEET to Vegas for marking.</p>
              </div>
          `;
      }

      async function fetchTimetable() {
        stopCountdown();
        const weekNum = Number(document.getElementById("weekNumber").value);
        const dayNum = Number(document.getElementById("dayNumber").value);
        const outputDiv = document.getElementById("output");
        const loadingDiv = document.getElementById("loading");

        if (!weekNum || !dayNum) {
          outputDiv.innerHTML =
            '<div class="result-card"><span class="error">Please select both week and day.</span></div>';
          return;
        }

        outputDiv.innerHTML = "";
        loadingDiv.style.display = "block";

        try {
          if (!contract || typeof contract.getToday !== "function") {
            outputDiv.innerHTML = `<div class="result-card"><span class="error">RPC/Contract Not Configured:</span> Set RPC_URL and CONTRACT_ADDRESS to enable blockchain reads. You selected Week ${weekNum}, ${DAYS_OF_WEEK[dayNum]}.</div>`;
            return;
          }

          const res = await contract.getToday(weekNum, dayNum);
          const [
            dayTypeIndex,
            subject,
            title,
            topics,
            questions,
            grade,
            time,
            startTime,
            duration,
            isCompleted,
            ipfsLink,
          ] = res;

          const dayType = DAY_TYPES[Number(dayTypeIndex)];
          let html = "";
          let cardClass = "result-card";
          const dayLabel = `Week ${weekNum}, ${DAYS_OF_WEEK[dayNum]}`;

          const durationMs = duration * 60n * 1000n;

          if (dayType === "Reading Day") {
            cardClass += isCompleted ? " card-read-complete" : "";
            html = `
              <h3>${dayLabel}: Reading Schedule</h3>
              <div class="result-detail"><strong>Status:</strong> ${
                isCompleted ? "Completed" : "Pending"
              }</div>
              <div class="result-detail"><strong>Subject:</strong> ${
                subject || "N/A"
              }</div>
              <div class="result-detail"><strong>Time:</strong> ${
                time || "N/A"
              }</div>
              <p style="margin-top: 15px; font-weight: 500;">Focus Topics:</p>
              <ul class="question-list" style="list-style: disc;">
                  ${
                    topics && topics.length
                      ? topics.map((t) => `<li>${t}</li>`).join("")
                      : "<li>No Topics Set (Rest Day?)</li>"
                  }
              </ul>
            `;
            if (isCompleted) {
              html +=
                '<div class="completion-check">DAY COMPLETED!✅ KEEP IT UP!.</div>';
            }
          } else if (dayType === "Exam Day") {
            if (isCompleted) {
              cardClass += " card-exam-complete";
              html = `
                  <h3>${title || subject} - Official Result</h3>
                  <div class="result-detail"><strong>Date:</strong> ${formatTimestamp(
                    startTime
                  )}</div>
                  <div class="result-detail"><strong>Duration:</strong> ${formatDuration(
                    durationMs
                  )}</div>
                  <h4 style="color: var(--primary-blue); margin-top: 20px;">FINAL GRADE:</h4>
                  <div class="grade-display">${
                    grade ? String(grade).toUpperCase() : "N/A"
                  }</div>
              `;
              if (ipfsLink && String(ipfsLink).trim() !== "") {
                html += `<p style="margin-top:15px;"><a href="${ipfsLink}" target="_blank" style="color:var(--primary-blue);font-weight:600;text-decoration:none;">📎 View Submitted Work (IPFS)</a></p>`;
              }
              html += `<p style="margin-top:20px;">Your official result has been recorded on the blockchain.</p>`;
            } else if (Number(startTime) === 0) {
              cardClass += " card-exam-start-pending";
              html = `
                  <h3>EXAM SCHEDULED: ${title || subject}</h3>
                  <div class="result-detail"><strong>Duration:</strong> ${formatDuration(
                    durationMs
                  )}</div>
                  <p style="margin-top: 15px; font-weight: 500; color: var(--error-red);">
                      WARNING: Once you click 'Start Exam', the ${formatDuration(
                        durationMs
                      )} timer begins instantly on the blockchain.
                  </p>
                  <button 
                      onclick="triggerExamStart(${weekNum}, ${dayNum})" 
                      class="start-exam-button"
                  >
                      🚀 CLICK HERE TO START EXAM & TIMER 🚀
                  </button>
                  <p style="margin-top: 30px; font-weight: 500;">Practice Questions (Review these before starting):</p>
                  
                  <div class="question-content">
                      ${
                        questions && questions.length > 0
                          ? questions.join("\n\n")
                          : "No questions available for preview."
                      }
                  </div>
              `;
            } else {
              cardClass += " card-exam-active";
              html = `
                  <h3>ACTIVE EXAM: ${title || subject}</h3>
                  <div class="result-detail"><strong>Start Time:</strong> ${formatTimestamp(
                    startTime
                  )}</div>
                  <div class="result-detail"><strong>Duration:</strong> ${formatDuration(
                    durationMs
                  )}</div>
                  <div id="countdownTimer" class="countdown-timer"></div>
                  
                  <p style="margin-top: 20px; font-weight: 500;">Exam Questions (Start answering now!):</p>
                  
                  <div class="question-content">
                      ${
                        questions && questions.length > 0
                          ? questions.join("\n\n")
                          : "No questions available for preview."
                      }
                  </div>
                  
                  <button 
                      onclick="closeQuestionPage()" 
                      class="close-button"
                  >
                      EXIT EXAM(GOODLUCK)
                  </button>
              `;
              startCountdown(startTime, duration);
            }
          } else {
            html =
              '<span class="error">Data is not available for this day. (Day Type: Not Set)</span>';
          }

          outputDiv.innerHTML = `<div class="${cardClass}">${html}</div>`;
        } catch (err) {
          console.error("Contract Call Error:", err);
          outputDiv.innerHTML = `<div class="result-card"><span class="error">Lookup failed. Check console for details.</span></div>`;
        } finally {
          loadingDiv.style.display = "none";
        }
      }

      // initialize on load
      window.addEventListener("load", () => {
        initProviderContract();
        populateDropdowns();
        fetchCandidateName();
      });
    </script>
  </body>
</html>

